<!DOCTYPE html>
<html lang="en-US">
   <head>
      <title>Snake</title>
      <meta charset="UTF-8" />
      <!--
         This code inspired by Gamkedo:
         https://youtu.be/xGmXxpIj6vs
       -->
       <style>
         body
         {
            background-color: #0f0f0f;
            color: white;
            font-family: monospace;
            font-size: 14px;
         }
         
         #divContent
         {
            width: 452px;
            text-align: justify;
         }
         
         canvas
         {
            border: 1px solid white;
         }
         
         .instructions
         {
            font-style: italic;
            color: #ff7fff;
         }
         
         .key
         {
            color: #007fff;
         }
         
         #lblScore
         {
            color: #00ff00;
         }
         
         #lblRecents
         {
            color: #ff7f00;
         }
         
         #lblHScore
         {
            color: #ffff00;
         }
         
         #lblPaused
         {
            color: #ff0000;
         }
       </style>
   </head>
   <body>
      <div id="divContent">
         <canvas id="gc" width="500px" height="500px"></canvas>
         <br />
         <label class="instructions">
            You are the green snake. You are hungry for apples.<br />
            Get the red apple to increase your length.<br />
            Be careful not to run into yourself or you'll shrink!
         </label>
         <br /><br />
         <label class='key'>A</label> or <label class='key'>&larr;</label> 
         to move left
         <br />
         <label class='key'>D</label> or <label class='key'>&rarr;</label>
         to move right
         <br />
         <label class='key'>W</label> or <label class='key'>&uarr;</label>
         to move up
         <br />
         <label class='key'>S</label> or <label class='key'>&darr;</label>
         to move down
         <br />
         <label class='key'>P</label> or <label class='key'>Pause/Break</label>
         to pause
         <br /><br />
         Score: <label id="lblScore"></label>
         <br />
         Recent Scores: <label id="lblRecents"></label>
         <br />
         High Score: <label id="lblHScore"></label>
         <br />
         <label id="lblPaused"></label>
      </div>
      <script type="text/javascript">
         // canvas globals
         var canvas     = domById('gc');
         var context    = canvas.getContext('2d');
         var lblScore   = domById('lblScore');
         var lblRecents = domById('lblRecents');
         var lblHScore  = domById('lblHScore');
         var lblPaused  = domById('lblPaused');
         var fps;
         
         // game globals
         var dim;     // snake & apple block width & height
         var ax;      // apple position X
         var ay;      // apple position Y
         var dx;      // snake velocity Dx
         var dy;      // snake velocity Dy
         var mag;     // (maximum) magnitude of velocity
         var snake;   // snake body (array of blocks)
         var score;   // current score
         var recents; // recent scores
         var hScore;  // high score
         var paused;  // is the game paused?
         
         /***********************************
          * GET DOCUMENT OBJECT MODEL BY ID *
          ***********************************/
         function domById(id)
         {
            return document.getElementById(id);
         }
         
         /******************
          * INITIALIZATION *
          ******************/
         window.onload = function()
         {
            // initialize globals
            fps     = 15;
            dim     = 10;
            mag     = dim;
            dx      = mag;
            dy      = 0;
            score   = 0;
            recents = '';
            hScore  = 0;
            paused  = false;
            
            // generate the apple
            regenApple();
            
            // generate the snake
            regenSnake();
            
            // specify the update callback
            updateCallback = updateAll;
            
            // run the loop
            setInterval(function()
            {
               drawAll();
               
               if (!paused)
               {
                  updateAll();
                  detectCollisions();
               }
               
               printData();
               
            }, 1000.0/fps);
         }
         
         /*********************
          * KEYBOARD CALLBACK *
          *********************/
         document.onkeydown = function(event)
         {
            switch(event.keyCode)
            {
               // a
               case 65:
               // left
               case 37:
                  // prohibit turning right
                  if (dx == 0 && dy != 0)
                  {
                     // turn to the left
                     dx = -mag;
                     dy = 0;
                  }
                  break;
              
               // w
               case 87:
               // up
               case 38:
                  // prohibit turning downward
                  if (dx != 0 && dy == 0)
                  {
                     // turn upward
                     dx = 0;
                     dy = -mag;
                  }
                  break;
               
               // d
               case 68:
               // right
               case 39:
                  // prohibit turning left
                  if (dx == 0 && dy != 0)
                  {
                     // turn to the right
                     dx = mag;
                     dy = 0;
                  }
                  break;
               
               // s
               case 83:
               // down
               case 40:
                  // prohibit moving upward
                  if (dx != 0 && dy == 0)
                  {
                     // turn downward
                     dx = 0;
                     dy = mag;
                  }
                  break;
               
               // p
               case 80:
               // pause / break
               case 19:
                  paused = !paused;
            }
         }
         
         /*****************************
          * UPDATE ALL OBJECTS & DATA *
          *****************************/
         function updateAll()
         {
            // move the snake
            var sl = snake.length - 1;            
            snake.push({x: snake[sl].x + dx, y: snake[sl].y + dy});
            snake.shift();            

            // wrap snake across screen
            for (i = sl; i >= 0; i--)
            {
               if (snake[i].x + dim > canvas.width)
                  snake[i].x = 0;
               else if (snake[i].x < 0)
                  snake[i].x = canvas.width;
               if (snake[i].y + dim > canvas.height)
                  snake[i].y = 0;
               else if (snake[i].y < 0)
                  snake[i].y = canvas.height;
            }
         }
         
         /******************************
          * PRINT DATA TO THE DOCUMENT *
          ******************************/
         function printData()
         {
            lblScore.innerHTML   = score;
            lblRecents.innerHTML = recents;
            lblHScore.innerHTML  = hScore;
            if (paused)
               lblPaused.innerHTML = 'PAUSED';
            else
               lblPaused.innerHTML = '';
         }
         
         /*************************
          * DETECT ALL COLLISIONS *
          *************************/
         function detectCollisions()
         {
            // if snake eats apple, move it and grow snake
            var sl = snake.length - 1;
            if (snake[sl].x == ax && snake[sl].y == ay)
            {
               regenApple();
               snake.unshift({x: snake[sl].x - dx, y: snake[sl].y - dy});
               score++;
               if (score > hScore)
                  hScore = score;
            }
            
            // if snake eats itself, shrink it back to beginning size
            for (i = 1; i < sl; i++)
            {
               if (snake[sl].x == snake[i].x && snake[sl].y == snake[i].y)
               {
                  for (i = 2; i < sl; i++)
                     snake.shift();
                  recents = score + ' ' + recents;
                  score   = 0
               }   
            }
         }
         
         /********************
          * DRAW ALL OBJECTS *
          ********************/
         function drawAll()
         {
            // draw the background
            context.fillStyle = '#000000';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            // draw the square
            context.fillStyle = "#ff0000";
            context.fillRect(ax, ay, dim, dim);

            // draw the snake
            for (i = 0; i < snake.length; i++)
            {
               context.fillStyle = "#00ff00";
               context.fillRect(snake[i].x, snake[i].y, dim, dim);
            }
         }
         
         /************************
          * REGENERATE THE APPLE *
          ************************/
         function regenApple()
         {
            ax = parseInt(Math.random() * canvas.width / dim) * dim;
            ay = parseInt(Math.random() * canvas.height / dim) * dim;
         }
         
         /************************
          * REGENERATE THE SNAKE *
          ************************/
         function regenSnake()
         {
            snake = [];
            var sx = canvas.width / 2;
            var sy = canvas.height / 2;
            snake.unshift({x: sx,          y: sy});
            snake.unshift({x: sx - dx,     y: sy - dy});
            snake.unshift({x: sx - 2 * dx, y: sy - 2 * dy});
         }
      </script>
   </body>
</html>
